<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Golang调度器GMP模型-学习笔记, 生活,旅行,成长">
    <meta name="description" content="关于GMP的学习笔记">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Golang调度器GMP模型-学习笔记 | ZoXu</title>
    <link rel="icon" type="image/png" href="/smallpig.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/pig.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">ZoXu</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/%E6%B8%B8%E8%AE%B0/" class="waves-effect waves-light">
      
      <i class="fas fa-plane" style="zoom: 0.6;"></i>
      
      <span>旅行</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="waves-effect waves-light">
      
      <i class="fas fa-code" style="zoom: 0.6;"></i>
      
      <span>技术笔记</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/%E6%88%91%E5%92%8C%E5%A5%B9" class="waves-effect waves-light">
      
      <i class="fas fa-heart" style="zoom: 0.6;"></i>
      
      <span>我和她</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/pig.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">ZoXu</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/%E6%B8%B8%E8%AE%B0/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-plane"></i>
			
			旅行
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-code"></i>
			
			技术笔记
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/%E6%88%91%E5%92%8C%E5%A5%B9" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-heart"></i>
			
			我和她
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/images/GMP.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Golang调度器GMP模型-学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">
                                <span class="chip bg-color">读书笔记</span>
                            </a>
                        
                            <a href="/tags/golang/">
                                <span class="chip bg-color">golang</span>
                            </a>
                        
                            <a href="/tags/GMP/">
                                <span class="chip bg-color">GMP</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="post-category">
                                技术笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-11
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>    首先要了解一下<code>并发（concurrency）</code>和<code>并行（parallesim）</code>的区别。</p>
<ul>
<li><p>并发：逻辑上具有处理多个同时性任务的能力</p>
</li>
<li><p>并行：物理上同一时刻执行多个并发任务</p>
</li>
</ul>
<p>    通常所说的<code>并发编程</code>，也就是说它允许多个任务同时执行。但实际上并不是在同一时刻被执行。在单核处理器上，通过多线程共享CPU时间片串行执行。</p>
<p>    <code>并行</code>则依赖于多核处理器等物理资源，让多个任务可以并行执行（并发且并行）。</p>
<p>     <img src="/2022/01/11/Golang-GMP/1.png" class="" title="多线程&#x2F;多进程操作系统"></p>
<h1 id="一、Golang调度器的由来"><a href="#一、Golang调度器的由来" class="headerlink" title="一、Golang调度器的由来"></a>一、Golang调度器的由来</h1><p>    前言中说道，多线程\多进程的操作系统中，解决了阻塞的问题。但是新的问题又出现了，进程拥有太多的资源，进程的创建、切换、销毁都会占用很长的时间。如果进程过多，CPU很大的一部分都用来进行进程调度了。</p>
<img src="/2022/01/11/Golang-GMP/2.png" class="" title="cpu浪费时间成本">

<h2 id="1-协程来提高CPU利用率"><a href="#1-协程来提高CPU利用率" class="headerlink" title="1.协程来提高CPU利用率"></a>1.协程来提高CPU利用率</h2><p>    多线程、多进程已经提高了系统的并发能力，但是在当今互联网高并发场景下，为每个任务都创建一个线程是不现实的，会消耗大量的内存。</p>
<p>    <strong>引入<code>内核态</code>线程和<code>用户态</code>线程</strong></p>
<blockquote>
<p> 一个“用户态线程”必须要绑定一个“内核态线程”，但是CPU并不知道有“用户态线程”的存在。它只知道它运行的是一个“内核态线程”。</p>
</blockquote>
<p>    <img src="/2022/01/11/Golang-GMP/3.png" class=""></p>
<p>    再去细化分类一下，内核线程依然叫做<code>线程(thread)</code>，用户线程叫做<code>协程(co-routine)</code></p>
<p>      <img src="/2022/01/11/Golang-GMP/4.png" class=""></p>
<h2 id="2-线程-thread-和协程-co-routine-的3种关系"><a href="#2-线程-thread-和协程-co-routine-的3种关系" class="headerlink" title="2.线程(thread)和协程(co-routine)的3种关系"></a>2.线程(thread)和协程(co-routine)的3种关系</h2><h3 id="1）N-1-关系"><a href="#1）N-1-关系" class="headerlink" title="1）N:1 关系"></a>1）N:1 关系</h3><p>    即<code>N个协程绑定1个线程</code>，优点是<strong>协程在用户态线程即完成切换，不会陷入内核态，切换轻量且快速</strong>。缺点：1个进程的所有协程都绑定在1个线程上。一旦某个协程阻塞，造成线程阻塞，本进程的其他协程都无法进行了，根本没有并发能力。</p>
<img src="/2022/01/11/Golang-GMP/5.png" class="" title="N:1关系">

<h3 id="2）1-1-关系"><a href="#2）1-1-关系" class="headerlink" title="2）1:1 关系"></a>2）1:1 关系</h3><p>    即<code>1 个协程绑定 1 个线程</code>。</p>
<p>    优点：最容易实现</p>
<p>    缺点：协程的创建、删除和切换的代价都由CPU完成，略显昂贵。</p>
<h3 id="3-M-N-关系"><a href="#3-M-N-关系" class="headerlink" title="3)  M:N 关系"></a>3)  M:N 关系</h3><p>    <code>M 个协程绑定 N 个线程</code> ，克服了以上两种模型的缺点，但实现起来最为复杂</p>
<img src="/2022/01/11/Golang-GMP/6.png" class="" title="M:N关系">

<p>    协程跟线程是有区别的。</p>
<p>    线程由CPU调度，是抢占式的。</p>
<p>    <strong>协程由用户态调度，是协作式的，一个协程让出CPU后，才执行下一个协程。</strong></p>
<h2 id="3-Go语言的协程goroutine"><a href="#3-Go语言的协程goroutine" class="headerlink" title="3.Go语言的协程goroutine"></a>3.Go语言的协程goroutine</h2><p>    <strong>Go为了提供更容易使用的并发方法，使用了goroutine和channel</strong>。</p>
<p>    goroutine来自协程的概念，让一组可复用的函数运行在一组线程之上。即使有协程阻塞，该线程的其他协程也可以被`runtime``调度，转移到其他可运行的线程上。</p>
<p>    Go中，协程被称为goroutine，它非常轻量，一个goroutine只占几KB，并且这几KB就足够goroutine运行完，这就能在有限的内存空前内支持大量goroutine，支持了更多的并发。虽然一个goroutine的栈只占几KB，但实际是可伸缩的，如果需要更多内容，`runtime``会自动为goroutine分配。</p>
<p>    goroutine特点：</p>
<ul>
<li><p>占用内存更小</p>
</li>
<li><p>调度更灵活</p>
</li>
</ul>
<h1 id="二、被废弃的goroutine调度器-GM模型"><a href="#二、被废弃的goroutine调度器-GM模型" class="headerlink" title="二、被废弃的goroutine调度器-GM模型"></a>二、被废弃的goroutine调度器-GM模型</h1><p>在Go1.1之前Go的调度模型其实是GM模型，现在使用的版本是2012年重新设计的。废弃GM模型的原因是调度器性能存在问题。</p>
<h2 id="1-GM模型实现原理"><a href="#1-GM模型实现原理" class="headerlink" title="1.GM模型实现原理"></a>1.GM模型实现原理</h2><blockquote>
<p>大部分文章都是会用 G 来表示 Goroutine，用 M 来表示线程，那么我们也会用这种表达的对应关系。</p>
</blockquote>
<p>   <img src="/2022/01/11/Golang-GMP/7.png" class="" title="对应关系"></p>
<p>用一个动图来展示一下GM模型的工作原理</p>
<p>   <img src="/2022/01/11/Golang-GMP/GM-gif.gif" class="G" title="GM模型工作原理"></p>
<h2 id="2-源码解读"><a href="#2-源码解读" class="headerlink" title="2.源码解读"></a>2.源码解读</h2><p>看一下Go1.0.1的调度器源码的核心关键步骤</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">static void
<span class="token function">schedule</span><span class="token punctuation">(</span>G <span class="token operator">*</span>gp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token operator">...</span>
 <span class="token function">schedlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>gp <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span>gp<span class="token operator">-</span><span class="token operator">></span>status<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> Grunnable<span class="token punctuation">:</span>
  <span class="token keyword">case</span> Gdead<span class="token punctuation">:</span>
   <span class="token comment">// Shouldn't have been running!</span>
   runtime·<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"bad gp->status in sched"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> Grunning<span class="token punctuation">:</span>
   gp<span class="token operator">-</span><span class="token operator">></span>status <span class="token operator">=</span> Grunnable<span class="token punctuation">;</span>
   <span class="token function">gput</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

 gp <span class="token operator">=</span> <span class="token function">nextgandunlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 gp<span class="token operator">-</span><span class="token operator">></span>readyonstop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 gp<span class="token operator">-</span><span class="token operator">></span>status <span class="token operator">=</span> Grunning<span class="token punctuation">;</span>
 m<span class="token operator">-</span><span class="token operator">></span>curg <span class="token operator">=</span> gp<span class="token punctuation">;</span>
 gp<span class="token operator">-</span><span class="token operator">></span>m <span class="token operator">=</span> m<span class="token punctuation">;</span>
 <span class="token operator">...</span>
 runtime·<span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token operator">-</span><span class="token operator">></span>sched<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分析一下过程：</p>
<ul>
<li><p>调用<code>schedlock()</code>方法获取全局锁</p>
</li>
<li><p>获取全局锁成功后，将当前Goroutine状态从Running（正在被调度）改为Runnable（可以被调度）</p>
</li>
<li><p>调用<code>gput</code>方法来保存当前Goroutine的运行状态等信息</p>
</li>
<li><p>调用<code>nextgandunlock</code>方法来寻找下一个可运行的Goroutine，并且释放全局锁给其他调度使用</p>
</li>
<li><p>获取到下一个待运行的Goroutine后，将其状态修改为Running。</p>
</li>
<li><p>调用<code>runtime.gogo</code>方法，将刚刚所获取到的下一个待执行的Goroutine运行起来，进入下一轮调度。</p>
</li>
</ul>
<h2 id="3-GM模型的缺点"><a href="#3-GM模型的缺点" class="headerlink" title="3.GM模型的缺点"></a>3.GM模型的缺点</h2><ul>
<li><p>创建、销毁、调度G都需要每个M获取锁，这就形成了激烈的锁竞争。</p>
</li>
<li><p>M转移G会造成延迟和额外的系统负载。比如当G中包含创建新协程G2，为了继续执行G，需要把G2交给M2执行，也就造成了很差的局部性。因为G和G2是相关的，最好放在M上执行，而不是其他M。</p>
</li>
<li><p>系统调用（CPU在M之间的切换）导致频繁的线程阻塞和取消阻塞操作增加了系统开销。</p>
</li>
</ul>
<h1 id="三、Goroutine调度器的GMP模型的设计思想"><a href="#三、Goroutine调度器的GMP模型的设计思想" class="headerlink" title="三、Goroutine调度器的GMP模型的设计思想"></a>三、Goroutine调度器的GMP模型的设计思想</h1><p>面对之前调度器的问题，Go设计了新的调度器。</p>
<p>在新的调度器中，除了M(thread)和G(goroutine)，又引进了P(Processor)</p>
<p>  <img src="/2022/01/11/Golang-GMP/8.png" class="" title="对应关系"></p>
<p><strong>Processor，它包含了运行goroutine的资源</strong>，如果线程想运行goroutine，必须先获取P，P中还包含了可运行的G队列。</p>
<h2 id="1-GMP模型"><a href="#1-GMP模型" class="headerlink" title="1.GMP模型"></a>1.GMP模型</h2><p>在Go中，线程是运行goroutine的实体，调度器的功能是把可运行的goroutine分配到工作线程上。</p>
<p> <img src="/2022/01/11/Golang-GMP/9.png" class="" title="GMP模型"></p>
<ul>
<li><p>全局队列（Global Queue）：存放等待运行的G。</p>
</li>
<li><p>P的本地队列：同全局队列类似，存放的也是等待运行的G，存的数量有限，不超过<code>256个</code>。新建G‘时，G’会有限加入到P的本地队列，如果队列满了，则会把本地队列中一半的G移动到全局队列。</p>
</li>
<li><p>P列表：所有的P都在程序启动时创建，并保存在数组中，最多有<code>GOMAXPROCS(可配置)</code>个。</p>
</li>
<li><p>M：线程想运行任务就得获取P，从P的本地队列获取G。</p>
</li>
</ul>
<h2 id="2-GMP的工作流程"><a href="#2-GMP的工作流程" class="headerlink" title="2.GMP的工作流程"></a>2.GMP的工作流程</h2><ul>
<li>新建<code>G</code>时，新<code>G</code>会优先加入到<code>P</code>的本地队列。如果本地队列满了，则会把本地队列中一半的G移动到全局队列。</li>
</ul>
<p>    <img src="/2022/01/11/Golang-GMP/GMP-1.gif" class="" title="GMP模型"></p>
<ul>
<li><code>P</code>的本地队列为空时，就从全局队列里获取。</li>
</ul>
<p>    <img src="/2022/01/11/Golang-GMP/GMP-2.gif" class="" title="GMP模型"></p>
<ul>
<li>如果全局队列为空时，<code>M</code> 会从其他<code>P</code>的本地队列偷（stealing）一半G放到自己<code>P</code>的本地队列</li>
</ul>
<p>    <img src="/2022/01/11/Golang-GMP/GMP-stealing.gif" class="" title="GMP模型"></p>
<ul>
<li><code>M</code>运行<code>G</code>，<code>G</code>执行之后，<code>M</code>会从<code>P</code>获取下一个<code>G</code>,不断重复下去。</li>
</ul>
<p>    <img src="/2022/01/11/Golang-GMP/GMP-3.gif" class="" title="GMP模型"></p>
<h2 id="3-有没有什么限制"><a href="#3-有没有什么限制" class="headerlink" title="3.有没有什么限制"></a>3.有没有什么限制</h2><p>在了解GMP的基础知识和运行原理之后，我们要知道在协程的运行过程中，真正干活的GMP又分别被什么约束？</p>
<h3 id="1）M的限制"><a href="#1）M的限制" class="headerlink" title="1）M的限制"></a>1）M的限制</h3><p>    在协程的执行中，真正干活的是M（系统线程），因为G是用户态的东西，最终执行都是得映射到一个M上去运行。</p>
<p>    那么M有没有限制呢？</p>
<p>    答案是：有的。在Go语言中，M的默认数量限制是10000，如果超出则会报错</p>
<pre class="line-numbers language-none"><code class="language-none">GO: runtime: program exceeds 10000-thread limit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>通常只有在Goroutine出现阻塞操作的情况下，才会遇到这种情况，这也可能预示着你的程序有问题。</p>
<p>一个M阻塞了，会创建新的M。</p>
<p>若确切是需要那么多，还可以通过 <code>debug.SetMaxThreads</code> 方法进行设置。</p>
<h3 id="2）G的限制"><a href="#2）G的限制" class="headerlink" title="2）G的限制"></a>2）G的限制</h3><p>Goroutine的创建数量是否有限制？</p>
<p>答案是：没有</p>
<p>但是理论上会受内存的影响。</p>
<p>答案是：没有。但<strong>理论上会受内存的影响</strong>，假设一个 Goroutine 创建需要 4k（via @GoWKH）：</p>
<ul>
<li><p>4k * 80,000 = 320,000k ≈ 0.3G内存</p>
</li>
<li><p>4k * 1,000,000 = 4,000,000k ≈ 4G内存</p>
</li>
</ul>
<p>以此就可以相对计算出来一台单机在通俗情况下，所能够创建 Goroutine 的大概数量级别。</p>
<p>注：Goroutine 创建所需申请的 2-4k 是需要连续的内存块。</p>
<h3 id="3）P的限制"><a href="#3）P的限制" class="headerlink" title="3）P的限制"></a>3）P的限制</h3><p><strong>P的数量受环境变量</strong><code>GOMAXPROCS</code> 的直接影响。</p>
<p>环境变量 <code>GOMAXPROCS</code> 又是什么？在 Go 语言中，通过设置 <code>GOMAXPROCS</code>，用户可以调整调度中 P（Processor）的数量。</p>
<p>另一个重点在于，与 P 相关联的的 M（系统线程），是需要绑定 P 才能进行具体的任务执行的，<strong>因此 P 的多少会影响到 Go 程序的运行表现</strong>。</p>
<p>P 的数量基本是受本机的核数影响。</p>
<h3 id="4）何为之合理？"><a href="#4）何为之合理？" class="headerlink" title="4）何为之合理？"></a>4）何为之合理？</h3><p>在介绍完 GMP 各自的限制后，我们回到一个重点，就是 “Goroutine 数量怎么预算，才叫合理？”。</p>
<p>“合理” 这个词，是需要看具体场景来定义的，可结合上述对 GPM 的学习和了解。得出：</p>
<ul>
<li><p>M：有限制，默认数量限制是 10000，可调整。</p>
</li>
<li><p>G：没限制，但受内存影响。</p>
</li>
<li><p>P：受本机的核数影响，可大可小，不影响 G 的数量创建。</p>
</li>
</ul>
<p>Goroutine 数量在 MG 的可控限额以下，多个把个、几十个，少几个其实没有什么影响，就可以称其为 “合理”。</p>
<h3 id="5）真实情况"><a href="#5）真实情况" class="headerlink" title="5）真实情况"></a>5）真实情况</h3><p>在真实的应用场景中，没法如此简单的定义。如果你 Goroutine：</p>
<ul>
<li><p>在频繁请求 HTTP，MySQL，打开文件等，那假设短时间内有几十万个协程在跑，那肯定就不大合理了（可能会导致  too many files open）。</p>
</li>
<li><p>常见的 Goroutine 泄露所导致的 CPU、Memory 上涨等，还是得看你的 Goroutine 里具体在跑什么东西。</p>
</li>
</ul>
<h2 id="4-P和M何时会被创建"><a href="#4-P和M何时会被创建" class="headerlink" title="4.P和M何时会被创建"></a>4.P和M何时会被创建</h2><p><code>P</code>:根据<code>GOMAXPROCS</code>来确定。运行时系统会根据这个数量创建n个P。</p>
<p><code>M</code>:没有足够的M来关联P并运行其中的可运行的G时。比如所有的M此时都阻塞住了，而P中还有很多就绪任务，就会去寻找空闲的M，而没有空闲的，就会去创建新的M。</p>
<h2 id="5-调度器的设计策略"><a href="#5-调度器的设计策略" class="headerlink" title="5.调度器的设计策略"></a>5.调度器的设计策略</h2><h3 id="1）复用线程："><a href="#1）复用线程：" class="headerlink" title="1）复用线程："></a>1）复用线程：</h3><ul>
<li><p>hand off机制：</p>
<p>当本线程因为G进行系统调用阻塞时，线程释放绑定的P，把P转移给其他空闲的线程执行。</p>
</li>
<li><p>work stealing机制：</p>
<p>当本线程无可运行的G时，尝试从其他线程绑定的P偷取G，而不是销毁线程。</p>
</li>
</ul>
<h3 id="2）利用并行"><a href="#2）利用并行" class="headerlink" title="2）利用并行"></a>2）利用并行</h3><p><code>GOMAXPROCS</code> 设置 P 的数量，最多有 <code>GOMAXPROCS </code>个线程分布在多个 CPU 上同时运行。<code>GOMAXPROCS</code> 也限制了并发的程度，比如 GOMAXPROCS = 核数/2，则最多利用了一半的 CPU 核进行并行。</p>
<h3 id="3）抢占"><a href="#3）抢占" class="headerlink" title="3）抢占"></a>3）抢占</h3><p>在<code>coroutine</code>中要等待一个协程主动让出CPU才执行下一个协程。</p>
<p>在Go中，一个<code>goroutine</code>最多占用CPU 10ms,防止其他goroutine被饿死，这就是goroutine不用于coroutine的一个 地方。</p>
<h3 id="4）全局G队列"><a href="#4）全局G队列" class="headerlink" title="4）全局G队列"></a>4）全局G队列</h3><p>在新的调度器中依然有全局G队列，但是功能已经被弱化了。</p>
<h2 id="6-go-func-调度流程"><a href="#6-go-func-调度流程" class="headerlink" title="6.go func()调度流程"></a>6.go func()调度流程</h2><p>    <img src="/2022/01/11/Golang-GMP/10.png" class=""></p>
<p>从上图可以得出以下结论:</p>
<ul>
<li><p>通过go func()来创建一个goroutine</p>
</li>
<li><p>有两种存储G的队列，一个是全局队列，一个是调度器P的本地队列。新建的G优先保存在P的本地队列中，P的本地队列慢了会保存在全局队列。</p>
</li>
<li><p>G只能运行在M中，一个M必须持有一个P，M与P是1:1的关系。M会从P的本地队列弹出一个可执行状态的G来执行。如果P的本地队列为空，就会从其他MP组合偷取一个可执行的G来执行。</p>
</li>
<li><p>一个M调度G执行的过程是一个循环机制。</p>
</li>
<li><p>当M执行某一个G时发生了syscall或其他阻塞操作，M会阻塞，如果当前有一些G待执行，runtime会把这个线程M从P中摘除，然后创建一个新的操作系统的线程（如果有空闲的线程可用就复用）来服务于这个P。</p>
</li>
</ul>
<h2 id="7-调度器的生命周期"><a href="#7-调度器的生命周期" class="headerlink" title="7.调度器的生命周期"></a>7.调度器的生命周期</h2><p>   <img src="/2022/01/11/Golang-GMP/11.png" class=""></p>
<p><strong>特殊的<code>M0</code>和<code>G0</code></strong></p>
<h3 id="M0"><a href="#M0" class="headerlink" title="M0"></a>M0</h3><p><code>M0</code>是启动程序后的编号为0的主线程，这个M对应的实例会在全局变量runtime.m0中，不需要heap上分配，M0负责执行初始化操作和启动第一个G，在之后M0就和其他M一样了。</p>
<h3 id="G0"><a href="#G0" class="headerlink" title="G0"></a>G0</h3><p><code>G0</code>是每次启动一个M都会第一个创建的Goroutine，G0仅用于调度G，G0不指向任何可执行的函数。每一个M都会有一个自己的G0。在调度或系统调用时会使用G0的栈空间。</p>
<h1 id="四、Go调度器调度场景过程全解析"><a href="#四、Go调度器调度场景过程全解析" class="headerlink" title="四、Go调度器调度场景过程全解析"></a>四、Go调度器调度场景过程全解析</h1><h2 id="场景1"><a href="#场景1" class="headerlink" title="场景1"></a>场景1</h2><p>P 拥有 G1，M1 获取 P 后开始运行 G1，G1 使用 <code>go func()</code> 创建了 G2，为了局部性 G2 优先加入到 P1 的本地队列</p>
 <img src="/2022/01/11/Golang-GMP/12.png" class="">

<h2 id="场景2"><a href="#场景2" class="headerlink" title="场景2"></a>场景2</h2><p>G1 运行完成后 (函数：goexit)，M 上运行的 goroutine 切换为 G0，G0 负责调度时协程的切换（函数：schedule）。从 P 的本地队列取 G2，从 G0 切换到 G2，并开始运行 G2 (函数：execute)。实现了线程 M1 的复用。</p>
<p> <img src="/2022/01/11/Golang-GMP/13.png" class=""></p>
<h2 id="场景3"><a href="#场景3" class="headerlink" title="场景3"></a>场景3</h2><p>假设每个 P 的本地队列只能存 3 个 G。G2 要创建了 6 个 G，前 3 个 G（G3, G4, G5）已经加入 p1 的本地队列，p1 本地队列满了。</p>
<p> <img src="/2022/01/11/Golang-GMP/14.png" class=""></p>
<h2 id="场景4"><a href="#场景4" class="headerlink" title="场景4"></a>场景4</h2><p>G2 在创建 G7 的时候，发现 P1 的本地队列已满，需要执行<strong>负载均衡</strong> (把 P1 中本地队列中前一半的 G，还有新创建 G <strong>转移</strong>到全局队列)</p>
<blockquote>
<p>（实现中并不一定是新的 G，如果 G 是 G2 之后就执行的，会被保存在本地队列，利用某个老的 G 替换新 G 加入全局队列）</p>
</blockquote>
<p> <img src="/2022/01/11/Golang-GMP/15.png" class=""></p>
<p>这些 G 被转移到全局队列时，会被打乱顺序。所以 G3,G4,G7 被转移到全局队列。</p>
<h2 id="场景5"><a href="#场景5" class="headerlink" title="场景5"></a>场景5</h2><p>G2 创建 G8 时，P1 的本地队列未满，所以 G8 会被加入到 P1 的本地队列。</p>
<p> <img src="/2022/01/11/Golang-GMP/16.png" class=""></p>
<p>G8 加入到 P1 点本地队列的原因还是因为 P1 此时在与 M1 绑定，而 G2 此时是 M1 在执行。所以 G2 创建的新的 G 会优先放置到自己的 M 绑定的 P 上。</p>
<h2 id="场景6"><a href="#场景6" class="headerlink" title="场景6"></a>场景6</h2><p> <img src="/2022/01/11/Golang-GMP/17.png" class=""></p>
<p>规定：<strong>在创建 G 时，运行的 G 会尝试唤醒其他空闲的 P 和 M 组合去执行</strong>。</p>
<p>假定 G2 唤醒了 M2，M2 绑定了 P2，并运行 G0，但 P2 本地队列没有 G，M2 此时为自旋线程<strong>（没有 G 但为运行状态的线程，不断寻找 G）</strong>。</p>
<h2 id="场景7"><a href="#场景7" class="headerlink" title="场景7"></a>场景7</h2><p>M2 尝试从全局队列 (简称 “GQ”) 取一批 G 放到 P2 的本地队列（函数：<code>findrunnable()</code>）。M2 从全局队列取的 G 数量符合下面的公式：</p>
<pre class="line-numbers language-none"><code class="language-none">n &#x3D; min(len(GQ)&#x2F;GOMAXPROCS + 1, len(GQ&#x2F;2))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>至少从全局队列取 1 个 g，但每次不要从全局队列移动太多的 g 到 p 本地队列，给其他 p 留点。这是<strong>从全局队列到 P 本地队列的负载均衡</strong>。</p>
<p> <img src="/2022/01/11/Golang-GMP/18.png" class=""></p>
<p>假定我们场景中一共有 4 个 P（GOMAXPROCS 设置为 4，那么我们允许最多就能用 4 个 P 来供 M 使用）。所以 M2 只从能从全局队列取 1 个 G（即 G3）移动 P2 本地队列，然后完成从 G0 到 G3 的切换，运行 G3。</p>
<h2 id="场景8"><a href="#场景8" class="headerlink" title="场景8"></a>场景8</h2><p>假设 G2 一直在 M1 上运行，经过 2 轮后，M2 已经把 G7、G4 从全局队列获取到了 P2 的本地队列并完成运行，全局队列和 P2 的本地队列都空了，如场景 8 图的左半部分。</p>
<p> <img src="/2022/01/11/Golang-GMP/19.png" class=""></p>
<p>全局队列已经没有 G，那 m 就要执行 work stealing (偷取)：从其他有 G 的 P 哪里偷取一半 G 过来，放到自己的 P 本地队列。P2 从 P1 的本地队列尾部取一半的 G，本例中一半则只有 1 个 G8，放到 P2 的本地队列并执行。</p>
<h2 id="场景9"><a href="#场景9" class="headerlink" title="场景9"></a>场景9</h2><p>G1 本地队列 G5、G6 已经被其他 M 偷走并运行完成，当前 M1 和 M2 分别在运行 G2 和 G8，M3 和 M4 没有 goroutine 可以运行，M3 和 M4 处于自旋状态，它们不断寻找 goroutine。</p>
<p> <img src="/2022/01/11/Golang-GMP/20.png" class=""></p>
<p>为什么要让 m3 和 m4 自旋，自旋本质是在运行，线程在运行却没有执行 G，就变成了浪费 CPU. 为什么不销毁现场，来节约 CPU 资源。因为创建和销毁 CPU 也会浪费时间，我们希望当有新 goroutine 创建时，立刻能有 M 运行它，如果销毁再新建就增加了时延，降低了效率。当然也考虑了过多的自旋线程是浪费 CPU，所以系统中最多有 GOMAXPROCS 个自旋的线程 (当前例子中的 GOMAXPROCS=4，所以一共 4 个 P)，多余的没事做线程会让他们休眠。</p>
<h2 id="场景10"><a href="#场景10" class="headerlink" title="场景10"></a>场景10</h2><p>假定当前除了 M3 和 M4 为自旋线程，还有 M5 和 M6 为空闲的线程 (没有得到 P 的绑定，注意我们这里最多就只能够存在 4 个 P，所以 P 的数量应该永远是 M&gt;=P, 大部分都是 M 在抢占需要运行的 P)，G8 创建了 G9，G8 进行了阻塞的系统调用，M2 和 P2 立即解绑，P2 会执行以下判断：如果 P2 本地队列有 G、全局队列有 G 或有空闲的 M，P2 都会立马唤醒 1 个 M 和它绑定，否则 P2 则会加入到空闲 P 列表，等待 M 来获取可用的 p。本场景中，P2 本地队列有 G9，可以和其他空闲的线程 M5 绑定。</p>
<p> <img src="/2022/01/11/Golang-GMP/21.png" class=""></p>
<h2 id="场景11"><a href="#场景11" class="headerlink" title="场景11"></a>场景11</h2><p>G8 创建了 G9，假如 G8 进行了<strong>非阻塞系统调用</strong>。</p>
<p> <img src="/2022/01/11/Golang-GMP/22.png" class=""></p>
<p>​ M2 和 P2 会解绑，但 M2 会记住 P2，然后 G8 和 M2 进入系统调用状态。当 G8 和 M2 退出系统调用时，会尝试获取 P2，如果无法获取，则获取空闲的 P，如果依然没有，G8 会被记为可运行状态，并加入到全局队列，M2 因为没有 P 的绑定而变成休眠状态 (长时间休眠等待 GC 回收销毁)。</p>
<h1 id="五、源码分析GMP模型"><a href="#五、源码分析GMP模型" class="headerlink" title="五、源码分析GMP模型"></a>五、源码分析GMP模型</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sunsky303/p/9705727.html">深入Golang调度器之GMP模型 - sunsky303 - 博客园</a></p>
</blockquote>
<h1 id="六、小结"><a href="#六、小结" class="headerlink" title="六、小结"></a>六、小结</h1><p>总结，Go 调度器很轻量也很简单，足以撑起 goroutine 的调度工作，并且让 Go 具有了原生（强大）并发的能力。<strong>Go 调度本质是把大量的 goroutine 分配到少量线程上去执行，并利用多核并行，实现更强大的并发</strong>。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1]《Golang 调度器 GMP 原理与调度全分析》 ——Aceld :<a target="_blank" rel="noopener" href="https://learnku.com/articles/41728">https://learnku.com/articles/41728</a></p>
<p>[2]《GMP模型为什么要有P》 ——煎鱼:<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/an7dml9NLOhqOZjEGLdEEw">https://mp.weixin.qq.com/s/an7dml9NLOhqOZjEGLdEEw</a></p>
<p>[3]《深入Golang调度器之GMP模型》 ——健の随笔:<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sunsky303/p/9705727.html">https://www.cnblogs.com/sunsky303/p/9705727.html</a>)</p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">
                                    <span class="chip bg-color">读书笔记</span>
                                </a>
                            
                                <a href="/tags/golang/">
                                    <span class="chip bg-color">golang</span>
                                </a>
                            
                                <a href="/tags/GMP/">
                                    <span class="chip bg-color">GMP</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/14/ARM64-TroubleShooting/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="记录一次go编译遇到坑">
                        
                        <span class="card-title">记录一次go编译遇到坑</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            记录arm架构下使用goland启动工程遇到的坑
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-14
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="post-category">
                                    技术笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/go-build%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/">
                        <span class="chip bg-color">go build遇到的坑</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/08/Induction3YearReview/">
                    <div class="card-image">
                        
                        <img src="/images/1.png" class="responsive-img" alt="入职3年啦">
                        
                        <span class="card-title">入职3年啦</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            对过去三年工作和生活的回顾
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%B0%8F%E5%91%A8%E7%9A%84%E5%8C%97%E6%BC%82%E7%94%9F%E6%B4%BB/" class="post-category">
                                    小周的北漂生活
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8C%97%E6%BC%82%E7%94%9F%E6%B4%BB/">
                        <span class="chip bg-color">北漂生活</span>
                    </a>
                    
                    <a href="/tags/%E8%81%8C%E5%9C%BA%E7%A2%8E%E7%A2%8E%E5%BF%B5/">
                        <span class="chip bg-color">职场碎碎念</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <!-- <a href="/about" target="_blank">ZoXu</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a> -->
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "5";
                        var startDate = "1";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Zoxu0928" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:zhouxu0928@126.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a src="/source/medias/reward/alipay.jpg" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 775650423" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>









    <a src="/source/medias/reward/alipay.jpg" class="tooltipped" target="_blank" data-tooltip="通过微信联系我:zhouxu_0928" data-position="top" data-delay="50">
        <i class="fab fa-weixin"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
